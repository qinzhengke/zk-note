<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: debug经验</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_markdown_programming_debug.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">debug经验 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3>debug和release的不要混用！</h3>
<p>debug时间，2017-09-25 20:00-22：00</p>
<p>一个de了快**两个小时**的bug！ 一段将二进制单通道图像转换成png图像的代码，文件前8个字节是W和H，接着是W*H长度的图像数据。 在imwrite的时候一直出错，W和H读出来的是正确的，搞了半天一直没有头绪，非常的苦恼。 其中还怀疑过是不是QtCreator的问题，然后用VisualStudio试了一遍，发现VisualStudio居然可以！（VS一开始也有问题，但随即发现是自己文件路径不对） 然后仔细对比了一下，发现在VS下链接的OpenCV库文件是opencv_world310d.lib，并且运行的方式是DEBUG。 然而在Creator中我链接的库是opencv_world310.lib，并且运行的方式是DEBUG。 加上后缀"d"之后，终于可以运行了！或者将运行方式改成release，同样也可以运行！ 这个bug在之前的imread函数是没有问题的，这进一步搞混淆了！</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> convert_bin_to_png(<span class="keywordtype">string</span> in_path, <span class="keywordtype">string</span> out_path)</div><div class="line">{</div><div class="line">  ifstream f;</div><div class="line">  f.open(in_path, ios::binary);</div><div class="line">  uint32_t W,H;</div><div class="line">  f.read((<span class="keywordtype">char</span>*)&amp;W, <span class="keyword">sizeof</span>(uint32_t));</div><div class="line">  f.read((<span class="keywordtype">char</span>*)&amp;H, <span class="keyword">sizeof</span>(uint32_t));</div><div class="line">  <span class="keywordtype">char</span> *img = <span class="keyword">new</span> <span class="keywordtype">char</span>[W*H];</div><div class="line">  f.read(img, W*H);</div><div class="line">  Mat save = Mat(H, W, CV8UC1);</div><div class="line">  save.data = (uint8_t)img;</div><div class="line">  imwrite(out_path, save); <span class="comment">// 问题就出现在这一行</span></div><div class="line">  <span class="keyword">delete</span> img;</div><div class="line">}</div></div><!-- fragment --><p><b>教训：</b> lib库的引用一定要**遵循规范**！debug版本的代码要引用debug版本的lib，release版本的代码要引用release版本的库。 举一反三，x64的编译方式用x64的库，x86的编译方式用x86的库，vc08，vc10，vc12的库最好也一致！</p>
<h3>使用Creator创建的控制台程序无任何输出？</h3>
<p>debug时间，2017-09-25 22:20-22:30</p>
<p>如题，程序本身是能够正确运行的，例如我输出的文件是正确的。 但是在终端运行程序时，程序本身没有任何输出，不论是正确的信息还是错误的信息。 最后发现是使用Creator构建程序时，没有在pro文件中加入CONFIG+=console导致的，加入之后程序就能正常输出了。 加入之后记得qmake+rebuild一下，仅仅重新编译有时候不会更新的。</p>
<p>**教训：**使用qtcreator构建工程时一定要清楚常用的几个参数的含义以及应用，pro文件并不是啥都不用写就能正确配置的。</p>
<h3>处理三通道图像出错？</h3>
<p>2017-09-26, debug时间，10分钟。</p>
<p>下面一段代码将float图像转换成color_map形式，在处理每个通道的数据时，地址没有写对，W和c忘记乘上通道数了。 </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> cvt2color(<span class="keywordtype">float</span> *img, uint32_t W, uint32_t H, uint8_t **img_out)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> uint32_t N = 511;</div><div class="line">    uint8_t color_map[N][3];</div><div class="line">    <span class="keywordflow">for</span>(uint32_t i=0; i&lt;N; i++)</div><div class="line">    {</div><div class="line">        color_map[i][0] = i&lt;=255 ? 255-i : 0;</div><div class="line">        color_map[i][1] = i&lt;=255 ? i : 510-i;</div><div class="line">        color_map[i][2] = i&lt;=255 ? 0 : i-255;</div><div class="line">    }</div><div class="line"></div><div class="line">    *img_out = <span class="keyword">new</span> uint8_t[3*W*H];</div><div class="line">    <span class="keywordflow">for</span>(uint32_t r=0; r&lt;H; r++)</div><div class="line">        <span class="keywordflow">for</span>(uint32_t c=0; c&lt;W; c++)</div><div class="line">        {</div><div class="line">            int32_t loc = (int32_t)img[r*W+c] + 255;</div><div class="line">            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;3; k++)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span>(loc &lt; 0)</div><div class="line">                    loc = 0;</div><div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(loc &gt; 510)</div><div class="line">                    loc = 510;</div><div class="line">                <span class="comment">// (*img_out)[r*W+c+k] = color_map[(uint32_t)loc][k]; // 错误</span></div><div class="line">                (*img_out)[r*3*W+3*c+k] = color_map[(uint32_t)loc][k]; <span class="comment">// 正确</span></div><div class="line"></div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>**教训：**处理多通道图像一定要注意寻址和通道的关系。</p>
<h3>定点化的程序反而更慢？</h3>
<p>2017-10-11 debug时间：1天</p>
<p>使用定点小数进行优化，在PC上跑是有1/5的时间减少的，但是移植到ARM上，发现反而运行的时间还更长，差不多是1.5倍左右，很纳闷。</p>
<p>原因：最后查到了程序中有一个限制运算数量的宏常数写错了。。。。本来要限制在XXX_YYY=1500的，结果却成了XXX_APP_YYY=5000。 两个宏搞混了，原因就是在pc版只有XXX_YYY这个宏，而在ARM版本上却将XXX_YYY偷偷改成了XXX_APP_YYY。</p>
<p>**教训：**不能太相信develop中的程序，任何地方都有可能变更，要有强大的内心的面对这一切，也要有仔细观察的耐心。</p>
<h3>数据读取出错？</h3>
<p>2017-10-26 debug时长：2小时 debug发现数据存储结构不符合预期，但是没找到为什么不符合预期，第二天重新测了一组数据，又变好了！</p>
<p>教训：嵌入式程序数据记录可能会有偶然问题，发现问题时一定要多测几组（至少两组）来先确认问题！</p>
<h3>fabs出错？</h3>
<p>2017-11-03 debug时长：10分钟 描述：fabs函数结果不对？这个问题很明显，printf出来就有问题。 原因：没有加入math.h头文件，这个愿意很坑爹，因为没有头文件，编译居然不报错。 一个只依赖于标准库的程序没遇到过这种问题，这个问题出现在引用别人的库的前提下，有的时候别人的库定义了这个函数，但是并不是正确的，或者是编译选项选择忽略这种问题，例如我在工作中，就发现一些找不到定义的函数只有警告而不是错误。</p>
<p>教训：这种明显很奇怪的问题，一般是和环境相关的，头文件什么的不要省，而且要怀疑提出编译的人。</p>
<h3>加了新功能，然后其他“不相关”模块崩溃？</h3>
<p>2017-12-06 debug时长， 30分钟 原因，通过指针形式获取别的线程结构体内容，然后处理过程中别的线程改动了那块内存上的数据，有可能那块内存已经被释放。 报错那是比较轻的结果，最可怕的是，刚好没有报错，那块内存是别人在用的，你偷偷踩了别人的内存，而别人的模块除了错还完全不知道什么回事。 俗称“踩内存”，如果不报错，这种问题很难发现，目前唯一比较有效的debug方式就是git回滚+review代码。</p>
<p>如果不确定通过指针获取的结构体会不会变，那么一定要自己定义一个结构体变量，然后传入地址，再memcpy一下，不要贪图简单，直接定义个指针传入。</p>
<h3>ifstream读取数据总是在特定长度出错？</h3>
<p>2018-01-02 debug时长，1个小时 描述：读取一个binary文件，文件的长度为143360字节，然而只能读取106个字节，之后总是fail，摸不着头脑 原因：读取binary文件的时候没有加入ios::bianry参数。 没有加入ios::binary参数，文件就会通过文本形式读取，读取时0x1A被认为是end of file，所以读取总在特定长度失效。</p>
<h3>文件总是读写有问题？</h3>
<p>2018-01-08 debug时长，2个小时 读出的文件不对？看看二进制参数是不是正确的，百分之八十的问题都来自这里。 C语言看"wb"和"rb"，c++看ios::binary </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
